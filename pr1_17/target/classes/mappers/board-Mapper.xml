<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.mapper.BoardMapper">
	<!-- 게시물의 내용을 반환해주는 쿼리 -->
	<select id="getSearchBoard" resultType="com.spring.pr1_17.dto.BoardDTO">
		<choose>
			<when test="searchKeyword.equals('total')">	<!-- 전체 검색일 경우 -->
				<choose>
					<when test="searchWord.equals('')"> <!-- 검색문자가 없을 경우 -->
						SELECT
							*
						FROM
							BOARD
						ORDER BY
							REF DESC,
							RE_STEP
						LIMIT
							#{startBoardIdx}, #{onePageViewCount}
					</when>
					<otherwise>							<!-- 검색문자가 있을 경우 -->
						SELECT
							*
						FROM 
							BOARD
						WHERE
							SUBJECT LIKE CONCAT('%',#{searchWord},'%') OR
							WRITER LIKE CONCAT('%',#{searchWord},'%')
						ORDER BY
							REF DESC,
							RE_STEP
						LIMIT
							#{startBoardIdx}, #{onePageViewCount}
					</otherwise>
				</choose>
			</when>
			<otherwise>	<!-- 전체 검색이 아닐 경우 -->
				SELECT
					*
				FROM
					BOARD
				WHERE
					<if test="searchKeyword.equals('writer')">
						WRITER LIKE CONCAT('%',#{searchWord},'%')
					</if>
					<if test="searchKeyword.equals('subject')">
						SUBJECT LIKE CONCAT('%',#{searchWord},'%')
					</if>
				ORDER BY
					REF DESC,
					RE_STEP
				LIMIT
					#{startBoardIdx}, #{onePageViewCount}
			</otherwise>
		</choose>
	</select>
	
	<!-- 전체 게시글 수를 반환해줌 -->
	<select id="getAllBoardCount" resultType="int">
		<choose>
			<when test="searchKeyword.equals('total')">
				<choose>
					<when test="searchWord.equals('')">
						SELECT
							COUNT(*)
						FROM
							BOARD
					</when>
					<otherwise>
						SELECT
							COUNT(*)
						FROM 
							BOARD
						WHERE
							SUBJECT LIKE CONCAT('%',#{searchWord},'%') OR
							WRITER LIKE CONCAT('%',#{searchWord},'%')
					</otherwise>
				</choose>
			</when>
			<otherwise>
				SELECT
					COUNT(*)
				FROM
					BOARD
				WHERE
					<if test="searchKeyword.equals('writer')">
						WRITER LIKE CONCAT('%',#{searchWord},'%')
					</if>
					<if test="searchKeyword.equals('subject')">
						SUBJECT LIKE CONCAT('%',#{searchWord},'%')
					</if>
					
			</otherwise>
		</choose>
	</select>
	
	<!-- 하나의 게시글을 반환하는 쿼리 -->
	<select id="getOneBoard" resultType="com.spring.pr1_17.dto.BoardDTO">
		SELECT
			*
		FROM 
			BOARD
		WHERE
			NUM = #{num}
	</select>
	
	<!-- 게사글 조회수 증가 쿼리 -->
	<update id="increaseReadCount">
		UPDATE
			BOARD
		SET
			READ_COUNT = READ_COUNT + 1
		WHERE
			NUM = #{num} 
	</update>
	
	<!-- 게시글을 저장하는 쿼리 -->
	<insert id="insertBoard">
		INSERT INTO
				BOARD
		VALUES	(
				(SELECT
					IFNULL(MAX(NUM)+1 , 1)
				 FROM
				 	BOARD AS B),
				 #{writer},
				 #{email},
				 #{subject},
				 #{password},
				 now(),
				 (SELECT
					IFNULL(MAX(REF)+1 , 1)
				 FROM
				 	BOARD AS B),
				 1,
				 1,
				 0,
				 #{content}
				)
	</insert>
</mapper>
